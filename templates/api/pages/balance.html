<!-- templates/api/pages/balance.html -->
{% extends 'api/base.html' %}

{% block title %}Currency Exchange API - Balance{% endblock %}
{% block balance_active %}class="active"{% endblock %}

{% block content %}
<h1>User Balance</h1>

<div class="section">
    <h2>Your Current Balance</h2>
    <button onclick="checkBalance()">Check Balance</button>
    <div id="balanceResult" class="result"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function checkBalance() {
        const resultDiv = document.getElementById('balanceResult');

        if (!accessToken) {
            resultDiv.innerHTML = `<div class="status error">Please log in first!</div>`;
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/balance/`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                },
            });

            if (response.status === 401) {
                // Try to refresh the token
                const refreshed = await refreshAuthToken();
                if (refreshed) {
                    return checkBalance();  // Try again with new token
                } else {
                    resultDiv.innerHTML = `<div class="status error">Session expired. Please log in again.</div>`;
                    return;
                }
            }

            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = `<div class="status success">User: ${data.username}</div>
                                      <div class="status success">Balance: ${data.balance} coins</div>`;
            } else {
                resultDiv.innerHTML = `<div class="status error">Request failed!</div>
                                      <pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
        }
    }

    // Load balance when page loads if user is authenticated
    document.addEventListener('DOMContentLoaded', function() {
        if (accessToken) {
            checkBalance();
        }
    });
</script>
{% endblock %}
